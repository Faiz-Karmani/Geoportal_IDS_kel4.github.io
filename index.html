<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pendukung Keputusan (SPK) Bencana Jakarta</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; }
        
        /* HEADER */
        #header {
            background: linear-gradient(90deg, #0d47a1 0%, #1565c0 100%);
            color: white; padding: 0 20px; height: 60px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 2000;
        }

        #main-content { display: flex; flex: 1; position: relative; }
        #map { flex: 1; height: 100%; z-index: 1; }

        /* SIDEBAR CHAT */
        #sidebar-right {
            width: 350px; background: #fff; border-left: 1px solid #ddd;
            display: flex; flex-direction: column; z-index: 1001;
            transition: transform 0.3s ease; box-shadow: -2px 0 10px rgba(0,0,0,0.05);
        }
        .sidebar-hidden { transform: translateX(100%); width: 0 !important; border: none; }

        /* LOGIN OVERLAY (MODAL) */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(13, 71, 161, 0.9); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .login-card {
            background: white; padding: 40px; border-radius: 15px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); width: 400px; text-align: center;
        }

        /* ANALISIS PANEL */
        #analysis-card {
            position: absolute; bottom: 30px; left: 20px; width: 350px;
            z-index: 1000; background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px); border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.2);
            display: none;
        }
        .card-header-custom { background: #e3f2fd; color: #0d47a1; border-radius: 12px 12px 0 0; padding: 10px 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center;}

        /* BADGES */
        .bg-bpn { background-color: #ff9800; color: #000; }
        .bg-bnpb { background-color: #d32f2f; color: #fff; }
        .bg-pemda { background-color: #388e3c; color: #fff; }
        .bg-big { background-color: #1976d2; color: #fff; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-card">
            <div class="mb-4">
                <i class="fa-solid fa-shield-halved fa-4x text-primary mb-3"></i>
                <h4 class="fw-bold">Login Portal SPK</h4>
                <p class="text-muted small">Silakan masuk menggunakan akun instansi.</p>
            </div>
            <div class="form-floating mb-3">
                <input type="text" class="form-control" id="username" placeholder="Username">
                <label for="username">Username</label>
            </div>
            <div class="form-floating mb-3">
                <input type="password" class="form-control" id="password" placeholder="Password">
                <label for="password">Password</label>
            </div>
            <button onclick="login()" class="btn btn-primary w-100 py-2 fw-bold">MASUK SISTEM</button>
            <div class="mt-3 text-start small bg-light p-2 rounded border">
                <i class="fa-solid fa-circle-info me-1"></i> <b>Akun Demo:</b><br>
                User: <code>bpn</code>, <code>bnpb</code>, <code>pemda</code>, <code>big</code><br>
                Pass: <code>123</code>
            </div>
        </div>
    </div>

    <div id="app-interface" style="display:none; height:100%; flex-direction:column;">
        
        <div id="header">
            <div class="d-flex align-items-center">
                <i class="fa-solid fa-layer-group fa-lg me-3"></i>
                <div>
                    <h6 class="m-0 fw-bold">SIGAP JAKARTA (Multi-Criteria Analysis)</h6>
                    <small class="opacity-75" style="font-size: 0.75rem;">Interoperabilitas Data Geospasial</small>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <div class="me-3 text-end d-none d-md-block">
                    <div class="fw-bold" id="user-display-name">Guest</div>
                    <div class="badge bg-light text-dark" id="user-display-role" style="font-size: 0.6rem;">UNKNOWN</div>
                </div>
                <button class="btn btn-sm btn-light text-primary fw-bold me-2 shadow-sm" onclick="toggleAnalysis()">
                    <i class="fa-solid fa-calculator me-1"></i> SPK
                </button>
                <button class="btn btn-sm btn-outline-light me-2" onclick="toggleSidebar()">
                    <i class="fa-regular fa-comments"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="logout()" title="Logout">
                    <i class="fa-solid fa-power-off"></i>
                </button>
            </div>
        </div>

        <div id="main-content">
            <div id="map"></div>

            <div id="analysis-card" class="card">
                <div class="card-header-custom">
                    <span><i class="fa-solid fa-wand-magic-sparkles me-2"></i>Analisis Dampak</span>
                    <button type="button" class="btn-close btn-close-sm" onclick="toggleAnalysis()"></button>
                </div>
                <div class="card-body p-3">
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted mb-1">1. Input Raster (Bahaya)</label>
                        <select class="form-select form-select-sm" id="input-raster">
                            <option value="bnpb_data:rawan_banjir">BNPB: Rawan Banjir (GeoTIFF)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted mb-1">2. Input Vektor (Aset)</label>
                        <select class="form-select form-select-sm" id="input-vector">
                            <option value="bpn_data:persil_tanah">BPN: Persil Tanah (WFS)</option>
                        </select>
                    </div>
                    <div class="mb-3 p-2 bg-light rounded border">
                        <label class="form-label small fw-bold text-dark mb-1 d-flex justify-content-between">
                            <span>Bobot Risiko</span> <span id="weight-val" class="text-primary">50%</span>
                        </label>
                        <input type="range" class="form-range" id="weight-slider" min="0" max="100" value="50" oninput="document.getElementById('weight-val').innerText = this.value + '%'">
                    </div>
                    <button onclick="runWPS()" class="btn btn-primary btn-sm w-100 fw-bold shadow-sm">
                        <i class="fa-solid fa-gears me-1"></i> JALANKAN WPS
                    </button>
                    <div id="wps-result" class="mt-3 p-2 bg-white border border-primary rounded d-none text-center">
                        <div class="spinner-border spinner-border-sm text-primary d-none" id="loading-spinner" role="status"></div>
                        <div id="result-content">
                            <h5 class="text-danger fw-bold m-0">1,245 Ha</h5>
                            <small class="text-muted">Luas Terdampak</small>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sidebar-right" class="sidebar-hidden">
                <div class="p-3 bg-white border-bottom d-flex justify-content-between align-items-center">
                    <h6 class="m-0 fw-bold"><i class="fa-regular fa-comments me-2"></i>Diskusi Instansi</h6>
                    <button class="btn btn-sm btn-light" onclick="toggleSidebar()">✖</button>
                </div>
                <div id="comments-list" class="flex-grow-1 p-3 overflow-auto bg-light">
                    </div>
                <div class="p-3 border-top bg-white">
                    <div class="input-group">
                        <input type="text" id="comment-text" class="form-control" placeholder="Ketik pesan...">
                        <button class="btn btn-primary" onclick="addComment()"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                    <div class="text-center mt-2">
                        <small class="text-muted" style="font-size: 0.7rem;">Anda login sebagai: <b id="chat-role-display">...</b></small>
                        <a href="#" onclick="clearComments()" class="text-danger ms-2" style="font-size: 0.7rem; text-decoration: none;">[Hapus Chat]</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- DATA USER (DATABASE SIMULASI) ---
        const USERS = {
            'bpn':   { pass: '123', role: 'Admin BPN',   color: 'bg-bpn' },
            'bnpb':  { pass: '123', role: 'Admin BNPB',  color: 'bg-bnpb' },
            'pemda': { pass: '123', role: 'Admin PEMDA', color: 'bg-pemda' },
            'big':   { pass: '123', role: 'Admin BIG',   color: 'bg-big' }
        };

        // --- KONFIGURASI ---
        const GEOSERVER_HOST = "https://geoserver-jakarta-wps.up.railway.app"; 
        let CURRENT_USER = null; // Menyimpan data user yg login

        // --- SISTEM LOGIN ---
        function checkSession() {
            const savedUser = localStorage.getItem('spk_user');
            if(savedUser && USERS[savedUser]) {
                currentUserInit(savedUser);
            } else {
                document.getElementById('login-overlay').style.display = 'flex';
                document.getElementById('app-interface').style.display = 'none';
            }
        }

        function login() {
            const u = document.getElementById('username').value.toLowerCase();
            const p = document.getElementById('password').value;

            if(USERS[u] && USERS[u].pass === p) {
                localStorage.setItem('spk_user', u);
                currentUserInit(u);
            } else {
                alert("Username atau Password salah!\nCoba: bpn / 123");
            }
        }

        function logout() {
            localStorage.removeItem('spk_user');
            location.reload();
        }

        function currentUserInit(username) {
            CURRENT_USER = { username: username, ...USERS[username] };
            
            // Update UI
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app-interface').style.display = 'flex';
            document.getElementById('user-display-name').innerText = CURRENT_USER.role;
            document.getElementById('user-display-role').innerText = "Logged in";
            document.getElementById('chat-role-display').innerText = CURRENT_USER.role;
            
            // Render Map (Fix Grey Map issue)
            setTimeout(() => { map.invalidateSize(); }, 500);
            loadComments();
        }

        // --- MAP SETUP ---
        const map = L.map('map', { zoomControl: false }).setView([-6.1754, 106.8272], 12);
        L.control.zoom({ position: 'topright' }).addTo(map);
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' }).addTo(map);

        // Layer Dummy (Ganti URL Senin nanti)
        const layers = {
            bnpb: L.tileLayer.wms(`${GEOSERVER_HOST}/geoserver/jakarta_interop/wms`, { layers: 'bnpb_data:rawan_banjir', format: 'image/png', transparent: true, opacity: 0.6 }),
            bpn: L.tileLayer.wms(`${GEOSERVER_HOST}/geoserver/jakarta_interop/wms`, { layers: 'bpn_data:persil_tanah', format: 'image/png', transparent: true })
        };
        L.control.layers(null, {"BNPB: Banjir": layers.bnpb, "BPN: Persil": layers.bpn}, { position: 'topright' }).addTo(map);

        // --- FITUR CHAT ---
        function addComment() {
            const text = document.getElementById('comment-text').value;
            if(!text.trim()) return;

            const newMsg = {
                role: CURRENT_USER.role,
                color: CURRENT_USER.color,
                text: text,
                time: new Date().toLocaleTimeString().slice(0,5)
            };

            // Simpan ke Array LocalStorage
            let history = JSON.parse(localStorage.getItem('chat_history_db') || "[]");
            history.push(newMsg);
            localStorage.setItem('chat_history_db', JSON.stringify(history));

            renderChat();
            document.getElementById('comment-text').value = '';
        }

        function renderChat() {
            const list = document.getElementById('comments-list');
            const history = JSON.parse(localStorage.getItem('chat_history_db') || "[]");
            
            if(history.length === 0) {
                list.innerHTML = '<div class="text-center text-muted mt-5 small">Belum ada diskusi.</div>';
                return;
            }

            list.innerHTML = history.map(msg => `
                <div class="mb-2 p-2 bg-white rounded shadow-sm border-start border-4 ${msg.color.replace('bg-', 'border-')}">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="badge ${msg.color}">${msg.role}</span>
                        <small class="text-muted" style="font-size:0.65rem">${msg.time}</small>
                    </div>
                    <div class="small text-dark">${msg.text}</div>
                </div>
            `).join('');
            
            list.scrollTop = list.scrollHeight;
        }

        function loadComments() { renderChat(); }
        function clearComments() { if(confirm('Hapus chat?')) { localStorage.removeItem('chat_history_db'); renderChat(); }}

        // --- UI TOGGLES ---
        function toggleAnalysis() { 
            const c = document.getElementById('analysis-card'); 
            c.style.display = c.style.display === 'none' ? 'block' : 'none'; 
        }
        function toggleSidebar() { 
            document.getElementById('sidebar-right').classList.toggle('sidebar-hidden'); 
        }
        function runWPS() {
            const res = document.getElementById('wps-result');
            const spin = document.getElementById('loading-spinner');
            const cont = document.getElementById('result-content');
            res.classList.remove('d-none'); spin.classList.remove('d-none'); cont.style.display = 'none';
            setTimeout(() => { spin.classList.add('d-none'); cont.style.display = 'block'; }, 1500);
        }

        // Init Login Check
        window.onload = checkSession;
    </script>
</body>
</html>
